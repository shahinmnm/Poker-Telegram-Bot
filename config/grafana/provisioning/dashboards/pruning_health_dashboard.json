{
  "uid": "pruning-health",
  "title": "Database Pruning Health",
  "tags": ["poker-bot", "monitoring"],
  "timezone": "utc",
  "schemaVersion": 16,
  "version": 1,
  "refresh": "30s",
  "panels": [
    {
      "id": 1,
      "title": "Pruning Operations Rate",
      "type": "graph",
      "gridPos": {"x": 0, "y": 0, "w": 12, "h": 8},
      "targets": [
        {
          "expr": "rate(poker_prune_executions_total[5m])",
          "legendFormat": "Prunes/sec",
          "refId": "A"
        }
      ],
      "yaxes": [
        {"format": "ops"},
        {"format": "short"}
      ]
    },
    {
      "id": 2,
      "title": "Stale User Count Distribution",
      "type": "graph",
      "gridPos": {"x": 12, "y": 0, "w": 12, "h": 8},
      "targets": [
        {
          "expr": "histogram_quantile(0.95, rate(poker_prune_stale_count_bucket[5m]))",
          "legendFormat": "p95 stale users",
          "refId": "A"
        },
        {
          "expr": "histogram_quantile(0.50, rate(poker_prune_stale_count_bucket[5m]))",
          "legendFormat": "p50 stale users",
          "refId": "B"
        }
      ]
    },
    {
      "id": 3,
      "title": "Pruning Duration (ms)",
      "type": "graph",
      "gridPos": {"x": 0, "y": 8, "w": 12, "h": 8},
      "targets": [
        {
          "expr": "histogram_quantile(0.99, rate(poker_prune_duration_ms_bucket[5m]))",
          "legendFormat": "p99 latency",
          "refId": "A"
        }
      ]
    },
    {
      "id": 4,
      "title": "High Stale Rate Alerts",
      "type": "graph",
      "gridPos": {"x": 12, "y": 8, "w": 12, "h": 8},
      "targets": [
        {
          "expr": "increase(poker_prune_high_stale_rate_total[1h])",
          "legendFormat": "Games with >50% stale users",
          "refId": "A"
        }
      ],
      "alert": {
        "name": "High Stale User Rate",
        "conditions": [
          {
            "evaluator": {"type": "gt", "params": [10]},
            "query": {"params": ["A", "5m", "now"]},
            "reducer": {"type": "avg"}
          }
        ],
        "frequency": "1m",
        "handler": 1,
        "message": "Multiple games have >50% stale users. Investigate user retention issues."
      }
    },
    {
      "id": 5,
      "title": "Pruning Health Status",
      "type": "singlestat",
      "gridPos": {"x": 0, "y": 16, "w": 24, "h": 4},
      "targets": [
        {
          "expr": "poker_pruning_health_status",
          "legendFormat": "{{status}}",
          "refId": "A"
        }
      ],
      "valueMaps": [
        {"value": "0", "text": "Unhealthy"},
        {"value": "1", "text": "Degraded"},
        {"value": "2", "text": "Healthy"}
      ]
    }
  ]
}
