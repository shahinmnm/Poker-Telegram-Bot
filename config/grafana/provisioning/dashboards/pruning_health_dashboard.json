{
  "uid": "poker-pruning-health",
  "title": "Poker Bot - Pruning Subsystem Health",
  "tags": ["poker", "pruning", "v81"],
  "timezone": "browser",
  "schemaVersion": 16,
  "version": 1,
  "panels": [
    {
      "id": 1,
      "title": "Pruning Operations Rate",
      "type": "graph",
      "targets": [
        {
          "expr": "rate(poker_prune_executions_total[5m])",
          "legendFormat": "Prunes/sec"
        }
      ]
    },
    {
      "id": 2,
      "title": "Stale User Count Distribution",
      "type": "graph",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, poker_prune_stale_count_bucket)",
          "legendFormat": "p95 stale users"
        },
        {
          "expr": "histogram_quantile(0.50, poker_prune_stale_count_bucket)",
          "legendFormat": "p50 stale users"
        }
      ]
    },
    {
      "id": 3,
      "title": "Pruning Duration (ms)",
      "type": "graph",
      "targets": [
        {
          "expr": "histogram_quantile(0.99, poker_prune_duration_ms_bucket)",
          "legendFormat": "p99 latency"
        }
      ]
    },
    {
      "id": 4,
      "title": "High Stale Rate Alerts",
      "type": "graph",
      "targets": [
        {
          "expr": "increase(poker_prune_high_stale_rate_total[1h])",
          "legendFormat": "Games with >50% stale users"
        }
      ],
      "alert": {
        "name": "High Stale User Rate",
        "conditions": [
          {
            "evaluator": {
              "type": "gt",
              "params": [10]
            },
            "query": {
              "params": ["A", "5m", "now"]
            }
          }
        ],
        "frequency": "1m",
        "handler": 1,
        "message": "Multiple games have >50% stale ready users. Investigate user retention issues."
      }
    },
    {
      "id": 5,
      "title": "Pruning Health Status",
      "type": "singlestat",
      "targets": [
        {
          "expr": "poker_pruning_health_status",
          "legendFormat": "{{status}}"
        }
      ],
      "valueMaps": [
        {"value": "0", "text": "Unhealthy"},
        {"value": "1", "text": "Degraded"},
        {"value": "2", "text": "Healthy"}
      ]
    }
  ],
  "refresh": "30s",
  "time": {"from": "now-6h", "to": "now"}
}
